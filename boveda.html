<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Vault Logic | Executive Bóveda</title>
    <style>
        :root { --gold: #d4af37; --alert: #ff4d4d; --safe: #00ff88; --dark: #050505; }
        body { background: radial-gradient(circle, #1a1a1a 0%, var(--dark) 100%); color: var(--gold); font-family: 'JetBrains Mono', monospace; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .report-container { background: rgba(10, 10, 10, 0.98); border: 1px solid rgba(212, 175, 55, 0.2); padding: 50px; max-width: 900px; width: 100%; display: none; }
        h1 { letter-spacing: 0.6em; font-size: 1.1rem; text-align: center; border-bottom: 1px solid #222; padding-bottom: 20px; }
        .data-row { margin: 40px 0; border-left: 4px solid var(--gold); padding-left: 35px; }
        .value { font-size: 2.6rem; color: #fff; font-weight: 600; }
        .wheel-section { display: flex; align-items: center; justify-content: space-around; margin: 60px 0; }
        #canvas-container { width: 380px; height: 380px; display: flex; align-items: center; justify-content: center; position: relative; }
        .directiva { background: rgba(212, 175, 55, 0.03); padding: 30px; border: 1px solid rgba(212, 175, 55, 0.1); border-left: 5px solid var(--gold); margin-top: 40px; color: #fff; }
        .btn-nasa { background: var(--gold); color: #000; border: none; padding: 20px; width: 100%; font-weight: bold; letter-spacing: 0.3em; cursor: pointer; text-transform: uppercase; margin-top: 30px; outline: 1px solid var(--gold); outline-offset: 3px; }
        .footer-tech { margin-top: 50px; padding-top: 20px; border-top: 1px solid #222; font-size: 0.6rem; color: #444; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="loading">CONECTANDO CON NÚCLEO NASA/JPL...</div>
    <div class="report-container" id="reporte">
        <h1>VAULT LOGIC // EXECUTIVE TERMINAL</h1>
        <div class="data-row">
            <span style="font-size: 0.7rem; color: #555; letter-spacing: 0.2em;">SUJETO DE ANÁLISIS</span>
            <div class="value" id="nombre">---</div>
        </div>
        <div class="wheel-section">
            <div style="text-align: right; font-size: 0.7rem; color: #666;">NODOS ACTIVOS<br><b style="color:#fff">10/10 [SECURE]</b></div>
            <div id="canvas-container"></div>
            <div style="text-align: left; font-size: 0.7rem; color: #666;">VECTORES TENSIÓN<br><b id="tension-count" style="color:var(--alert)">CALCULANDO...</b></div>
        </div>
        <div class="directiva">
            <span style="font-size: 0.7rem; color: var(--gold); display: block; margin-bottom: 10px;">DIRECTIVA DE SINCRONÍA:</span>
            <div id="directiva">---</div>
        </div>
        <button class="btn-nasa" onclick="location.href='suscripcion.html'">ACTIVAR CENTRO DE COMANDO GÉNESIS</button>
        <div class="footer-tech">
            PROTOCOL ID: GX-992-B // DATA SOURCE: NASA JPL DE441 // PRECISION: ±0.0001°<br>
            Este reporte constituye un activo de inteligencia estratégica bajo licencia técnica.
        </div>
    </div>

    <script>
// 1. MOTOR DE DIBUJO GEOMÉTRICO (SVG)
function dibujarMapaSVG(vectores, aspectos) {
    const contenedor = document.getElementById('canvas-container');
    const centro = 190; // Centro del radar
    const radio = 145;  // Radio del círculo principal
    
    if (!vectores) return;

    // Iniciamos la construcción del SVG como una cadena de texto (más estable)
    let cuerpoSVG = `<svg viewBox="0 0 380 380" style="width:100%; height:100%; filter: drop-shadow(0 0 10px rgba(212,175,55,0.1));">
        <circle cx="${centro}" cy="${centro}" r="${radio}" fill="none" stroke="rgba(212,175,55,0.2)" stroke-width="1.5" />
        <circle cx="${centro}" cy="${centro}" r="${radio + 12}" fill="none" stroke="rgba(212,175,55,0.05)" stroke-width="1" />`;

    // 2. DIBUJAR ASPECTOS (Líneas de relación entre puntos)
    if (aspectos) {
        aspectos.forEach(asp => {
            const p1 = vectores[asp.puntos.split('-')[0]];
            const p2 = vectores[asp.puntos.split('-')[1]];
            
            if (p1 !== undefined && p2 !== undefined) {
                // Conversión de grados a coordenadas X,Y
                const x1 = centro + radio * Math.cos((p1 - 90) * Math.PI / 180);
                const y1 = centro + radio * Math.sin((p1 - 90) * Math.PI / 180);
                const x2 = centro + radio * Math.cos((p2 - 90) * Math.PI / 180);
                const y2 = centro + radio * Math.sin((p2 - 90) * Math.PI / 180);
                
                const esTension = (asp.tipo === 'OPOSICIÓN' || asp.tipo === 'CUADRATURA');
                const color = esTension ? '#ff4d4d' : '#00ff88';
                const estilo = esTension ? '5,5' : '0';
                
                cuerpoSVG += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${color}" stroke-width="1.2" stroke-dasharray="${estilo}" opacity="0.4" />`;
            }
        });
        document.getElementById('tension-count').innerText = `${aspectos.length} VECTORES ACTIVOS`;
    }

    // 3. DIBUJAR NODOS (Puntos de datos/Planetas)
    Object.entries(vectores).forEach(([nombre, grado]) => {
        const x = centro + radio * Math.cos((grado - 90) * Math.PI / 180);
        const y = centro + radio * Math.sin((grado - 90) * Math.PI / 180);
        
        cuerpoSVG += `
            <circle cx="${x}" cy="${y}" r="5" fill="#fff" />
            <text x="${x + 12}" y="${y + 4}" fill="#d4af37" font-size="10" font-family="JetBrains Mono" font-weight="bold">${nombre.toUpperCase()}</text>`;
    });

    cuerpoSVG += `</svg>`;
    contenedor.innerHTML = cuerpoSVG;
}

// 2. FUNCIÓN DE CARGA DE DATOS
async function inicializarBoveda() {
    const params = new URLSearchParams(window.location.search);
    const email = params.get('email');
    
    if (!email) {
        document.getElementById('loading').innerText = "ERROR: NO SE DETECTÓ CREDENCIAL (EMAIL)";
        return;
    }

    try {
        const response = await fetch(`https://vault-strategy-api.onrender.com/obtener_reporte/${encodeURIComponent(email)}`);
        const result = await response.json();

        if (result.status === "success") {
            const d = result.data;
            
            // Inyectar datos en el panel
            document.getElementById('nombre').innerText = d.nombre.toUpperCase();
            document.getElementById('directiva').innerText = d.directiva;
            
            // Cambiar estados visuales
            document.getElementById('loading').style.display = 'none';
            document.getElementById('reporte').style.display = 'block';
            
            // Renderizar el mapa geométrico
            if (d.mapatotal && d.mapatotal.vectores_eclipticos) {
                dibujarMapaSVG(d.mapatotal.vectores_eclipticos, d.mapatotal.analisis_kepler || []);
            }
        } else {
            document.getElementById('loading').innerText = "ID NO ENCONTRADO EN LA BASE DE DATOS NASA";
        }
    } catch (error) {
        document.getElementById('loading').innerText = "FALLO DE CONEXIÓN CON EL SERVIDOR";
    }
}

window.onload = inicializarBoveda;
        
    </script>
</body>
</html>
